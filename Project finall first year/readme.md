<div align="center"> <h1 align="center"> Задача предсказания отношения количества репостов к просмотрам для постов телеграмм с целью выявления лучших постов и размещения их на канале. </h1> </div>
 
<div align="center"> <h3 align="center"> by Aleksey Kolychev </h3> </div>

<div align="center"> <h3 align="center">Предыстория</h3> </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Девушка завела телеграмм канал и мне стало интересно, отчего зависит популярность канала. Я предположил, что от контента. Тогда сразу вопрос, какой должен быть контент, чтобы канал имел стабильную аудиторию, которой можно продавать рекламу. Тогда и родился этот проект. </div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Целью данного проекта было создать модель машинного обучения, предсказывающую основной критерий хорошего сообщения для каналов в жанре «Познавательное». Причем, пост – это либо гиф или видео с небольшим текстом Основным критерием был выбрано отношение количества репостов к количеству просмотров. Это, по моему мнению, означает, что пост настолько хорош, что его можно переслать друзьям или родственникам, поделиться им с другими. </div>


<div align="center"> <h3 align="center"> Проект состоит из нескольких частей:</h3> </div>
1. Сбор информации о сообщениях с помощью библиотеки telethone
2.	Подготовка датасета к ML 
3.	Обучение модели ML
4.	Написание бота, которые по присланному ему сообщению (с GIF или с video) выдает прогноз репостовости
5.	EDA для попытки объяснить полученные результаты


<div align="center"> <h2 align="center"> 1.	Сбор информации о сообщениях с помощью библиотеки telethone </h2> </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; С telethon был написан скрипт, который забирал бы все сообщения у выбранных каналов, которых было около 400 штук. Это было реализовано в скрипте «1. Data maining Telethone». Однако, в дальнейшем, данная библиотека вышла из строя: при попытке зайти в нее через аккаунт в ТГ, акк. удалялся со всех устройств.
Впоследствии, чтобы написать бота, пришлось отказаться от формы telethone и преобразовывать форму сообщений aiogram в форму telethone.</div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Для этого потребовалось взять данные по датам, media, текст сообщения и картинку (thumbs) от видео. C библиотекой telethon удалось собрать данные о 39000 + постов из более 400 каналов из раздела «Познавательное». Скрипт сбора данных прилагается. Несколько раз был забанен =) </div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; При получении данных сообщений была добавлена возможность скачки эскиза видео для дальнейшей цветовой оценки его и создания новых признаков. Скачивать целое видео не представлялось возможным по имеющимся ресурсам. Название файла в папке добавлялось в исходный (до преобразований) датафрейм. 
 </div>

<div align="center"> <h2 align="center"> 2.	Подготовка датасета к ML </h2> </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Из исходного датасета необходимо было выделить признаки, по которым в дальнейшем создавалась ML модель (2. Dataset Prepration). </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Новые признаки создавались по следующим направлениям:</div>

1. 	Анализ сентиментов (эмоции в сообщении)
2.	Наличие эмодзи
3.	Анализ изображений (из видео): 
    1. Модель HSV – Среднее и СКО Hue, Saturation, Value
    2. Модель HSV – минимальное, максимальное, медианное значение
    3. Модель RGB - Среднее и СКО Red, Green, Blue.
    4. Модель RGB – минимальное, максимальное, медианное значение
    5. Модель HSV – количество цветов
4.	Анализ текста сообщений
    1.	Лемматизация
    2.	Выделение частоты слова 
    3.	Определение максимальной длины строки (301)
    4.	Создание признаков порядка слова в сообщении (если слово встречается чаще, то оно будет иметь более высокое значение от 0 до 1 на позиции в сообщении). Например, строка: «Красивая погода сегодня».  Строки из трех слов. Частота слова «Красивая» 0.98, погода 0.87, сегодня 0.65. Тогда признаки будут следующими: 0.98 0.87 0.65 0 0 0 …. 0 0 0 (всего 301 позиция). Так был зашифрован текст
    5.	Определение количества слов в сообщении
5. Наличие форматирования (entities)
    1. При анализе сообщений из telethon были свои типы оформления, однако, для aiogram они другие. Telethon теперь недоступен поэтому эти признаки всегда в нуле, хотя в датасете для обучения они есть и играют важную роль.

<div align="center"> <h2 align="center"> 3.	Обучение модели ML  </h2> </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;После подготовки датасета получилось 1345 признаков (файл 3. Model training)</div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Особенностью обучения было то, что таргет отличался на несколько порядков. Поэтому было применено логарифмирование не только таргета, а таких подобных признаков.</div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Далее была применена стандартизация ко всем признакам, датафрейм разделен на X и y, применен test_train_split и далее создавались модели ML.</div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Были опробованы следующие модели:</div>

1.	Линейная регрессия
2.	Линейная регрессия с регуляризацией Лассо
3.	Линейная регрессия с регуляризацией Ридж
4.	Деревья решений
5.	GradientBoostingRegressor
6.	XGBRegressor
7.	CatBoostRegressor

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Наилучшие результаты показал  CatBoostRegressor, поэтому он был выбран, как модель для предсказания рейтинга (отношения числа репостов к просмотрам) </div>

<div align="center"> <h2 align="center"> 4.Написание бота, которые по присланному ему сообщению (с GIF или с video)  </h2> </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Бот был написан на aiogram (bot.py). Бот должен принимать пост, анализировать его и выдавать оценку поста – отношение количества репостов к просмотрам.  Для этого необходимо было преобразовать ноутбук подготовки датасета в скрипт, который на выходе дает предсказания. Бот принимает гиф или видео с подписью или без нее. И через некоторое время выдает результат в форме числа – прогнозной оценки отношения числа репостов к просмотрам. Протестировать бота можно, если напишите в ЛС.</div>

<div align="center"> <h2 align="center"> 5. EDA </h2> </div>
<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Для попытки объяснения было проведено EDA уже после ML, на основе features important для CatBoostRegressor (файл 4. EDA (additional)). Наиболее важным оказалось ширина и высота видео, наличие цветов и первых шести слов, чтобы они были самыми популярными. Все, что было сложно объяснить оставалось без комментариев. Из важного стоит выделить, что соотношение близкое к золотому сечению, наверное, основной признак. В целом, проект получился интересным. Получена основа для полного анализа телеграмм каналов и создание образа идеального поста. Однако, проблема с библиотекой telethon делает эту задачу проблематичной.</div>

<div align="center"> <h2 align="center"> 6*. Кластеризация </h2> </div>

<div align="justify"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Была предпринята попытка кластеризирвоать объекты датасета, однако, ни к чему это не привело (Файл Clusters). DBScan указал на необходимость создании 10 тыс. кластеров для наибольшего коэффициента Силуэта. </div>

<div align="center"> <h2 align="center"> Скриншоты </h2> </div>

![title](screenshots/pic.jpg)

<div align="center"> <h2 align="center"> ВЫВОДЫ </h2> </div>

1.	Была проделана большая работа по анализу постов в ТГ и созданию модели ML для предсказания репостовости поста.
2.	Производился анализ текста, изображений, эмодзи и оформления. 
3.	Получилась точность MAE – 0.02 и MAPE – 36 % на тесте, что для таргета, отличающегося на несколько порядков хороший показатель
4.	Фундаментально существуют характеристики поста, которые влияют на отношение к нему человека, как биологического вида, например, золотое сечение. 
5.	Получен большой опыт в DS в части сбора, обработки датафреймов, подготовки к ML, обучение и продакшн. 
6.	Я собой доволен.
